{"version":3,"sources":["../src/listener.js"],"names":["updatePitch","analyserNode","sampleRate","data","Float32Array","fftSize","getFloatTimeDomainData","pitch","clarity","converted","pitchToNote","roundedPitch","Math","round","roundedClarity","document","getElementById","textContent","String","note","octave","tune","style","color","window","requestAnimationFrame","addEventListener","audioContext","AudioContext","webkitAudioContext","createAnalyser","navigator","mediaDevices","getUserMedia","audio","then","stream","sourceNode","createMediaStreamSource","connect","A4","a","pow","stepAbove","undefined","stepBelow","steps","above","below","i","frequency","nextFrequency","outside","closest","n","abs","tuning","ratio","max","min","index","notes","output"],"mappings":";;;;;;;;AACA;;;;;;;;;;AAEA,SAASA,WAAT,CAAqBC,YAArB,EAAmCC,UAAnC,EAA+C;AAC7C,MAAIC,IAAI,GAAG,IAAIC,YAAJ,CAAiBH,YAAY,CAACI,OAA9B,CAAX;AACAJ,EAAAA,YAAY,CAACK,sBAAb,CAAoCH,IAApC;;AAF6C,mBAGtB,uBAAUA,IAAV,EAAgBD,UAAhB,CAHsB;AAAA;AAAA,MAGxCK,KAHwC;AAAA,MAGjCC,OAHiC;;AAK7C,MAAIA,OAAO,GAAG,IAAd,EAAoB;AAClB,QAAIC,SAAS,GAAGC,WAAW,CAACH,KAAD,CAA3B;AACA,QAAII,YAAY,GAAGC,IAAI,CAACC,KAAL,CAAWN,KAAK,GAAG,GAAnB,IAA0B,GAA7C;AACA,QAAIO,cAAc,GAAGF,IAAI,CAACC,KAAL,CAAWL,OAAO,GAAG,GAArB,CAArB;AACAO,IAAAA,QAAQ,CAACC,cAAT,CAAwB,KAAxB,EAA+BC,WAA/B,GAA6C,SAA7C;AACAF,IAAAA,QAAQ,CAACC,cAAT,CAAwB,OAAxB,EAAiCC,WAAjC,GAA+CC,MAAM,CAACP,YAAD,CAArD;AACAI,IAAAA,QAAQ,CAACC,cAAT,CAAwB,MAAxB,EAAgCC,WAAhC,GAA8CR,SAAS,CAACU,IAAxD;AACAJ,IAAAA,QAAQ,CAACC,cAAT,CAAwB,QAAxB,EAAkCC,WAAlC,GAAgDR,SAAS,CAACW,MAA1D;AACAL,IAAAA,QAAQ,CAACC,cAAT,CAAwB,QAAxB,EAAkCC,WAAlC,GAAgDR,SAAS,CAACY,IAA1D;AACAN,IAAAA,QAAQ,CAACC,cAAT,CAAwB,SAAxB,EAAmCC,WAAnC,GAAiDC,MAAM,CAACJ,cAAD,CAAvD;AACAC,IAAAA,QAAQ,CAACC,cAAT,CAAwB,SAAxB,EAAmCM,KAAnC,CAAyCC,KAAzC,GAAiD,OAAjD;AACD,GAXD,MAWO;AACL,QAAIT,cAAc,GAAGF,IAAI,CAACC,KAAL,CAAWL,OAAO,GAAG,GAArB,CAArB;AACAO,IAAAA,QAAQ,CAACC,cAAT,CAAwB,KAAxB,EAA+BC,WAA/B,GAA6C,OAA7C;AACAF,IAAAA,QAAQ,CAACC,cAAT,CAAwB,SAAxB,EAAmCC,WAAnC,GAAiDC,MAAM,CAACJ,cAAD,CAAvD;AACAC,IAAAA,QAAQ,CAACC,cAAT,CAAwB,SAAxB,EAAmCM,KAAnC,CAAyCC,KAAzC,GAAiD,KAAjD;AACD;;AACDC,EAAAA,MAAM,CAACC,qBAAP,CAA6B,MAAMzB,WAAW,CAACC,YAAD,EAAeC,UAAf,CAA9C;AACD;;AAEDa,QAAQ,CAACW,gBAAT,CAA0B,kBAA1B,EAA8C,MAAM;AAClD;AACA,MAAIC,YAAY,GAAG,KAAKH,MAAM,CAACI,YAAP,IAAuBJ,MAAM,CAACK,kBAAnC,GAAnB;AACA,MAAI5B,YAAY,GAAG0B,YAAY,CAACG,cAAb,EAAnB;AAEAC,EAAAA,SAAS,CAACC,YAAV,CAAuBC,YAAvB,CAAoC;AAAEC,IAAAA,KAAK,EAAE;AAAT,GAApC,EAAqDC,IAArD,CAA2DC,MAAD,IAAY;AACpE,QAAIC,UAAU,GAAGV,YAAY,CAACW,uBAAb,CAAqCF,MAArC,CAAjB;AACAC,IAAAA,UAAU,CAACE,OAAX,CAAmBtC,YAAnB;AACAD,IAAAA,WAAW,CAACC,YAAD,EAAe0B,YAAY,CAACzB,UAA5B,CAAX;AACD,GAJD;AAKD,CAVD;;AAYA,SAASQ,WAAT,CAAqBH,KAArB,EAA4B;AAC1B;AACA;AACA;AACA;AACA;AACA;AAEA,MAAIiC,EAAE,GAAG,GAAT;AACA,MAAIC,CAAC,GAAG7B,IAAI,CAAC8B,GAAL,CAAS,CAAT,EAAa,IAAE,EAAf,CAAR;AACA,MAAIC,SAAS,GAAGC,SAAhB;AACA,MAAIC,SAAS,GAAGD,SAAhB;AACA,MAAIE,KAAK,GAAG;AACVC,IAAAA,KAAK,EAAE,CADG;AAEVC,IAAAA,KAAK,EAAE,CAFG,CAKZ;;AALY,GAAZ;;AAMA,MAAIzC,KAAK,IAAIiC,EAAb,EAAiB;AACf,SAAK,IAAIS,CAAC,GAAG,CAAb,EAAgBA,CAAC,IAAI,EAArB,EAAyBA,CAAC,EAA1B,EAA8B;AAC5B,UAAIC,SAAS,GAAGV,EAAE,GAAG5B,IAAI,CAAC8B,GAAL,CAASD,CAAT,EAAYQ,CAAZ,CAArB;AACA,UAAIE,aAAa,GAAGX,EAAE,GAAG5B,IAAI,CAAC8B,GAAL,CAASD,CAAT,EAAYQ,CAAC,GAAG,CAAhB,CAAzB;;AACA,UAAI1C,KAAK,IAAI2C,SAAT,IAAsB3C,KAAK,IAAI4C,aAAnC,EAAkD;AAChDR,QAAAA,SAAS,GAAGQ,aAAZ;AACAL,QAAAA,KAAK,CAACC,KAAN,GAAcE,CAAC,GAAG,CAAlB;AACAJ,QAAAA,SAAS,GAAGK,SAAZ;AACAJ,QAAAA,KAAK,CAACE,KAAN,GAAcC,CAAd;AACA;AACD;AACF;AACF,GAZD,MAYO;AACL,SAAK,IAAIA,CAAC,GAAG,CAAb,EAAgBA,CAAC,IAAI,CAAC,EAAtB,EAA0BA,CAAC,EAA3B,EAA+B;AAC7B,UAAIC,SAAS,GAAGV,EAAE,GAAG5B,IAAI,CAAC8B,GAAL,CAASD,CAAT,EAAYQ,CAAZ,CAArB;AACA,UAAIE,aAAa,GAAGX,EAAE,GAAG5B,IAAI,CAAC8B,GAAL,CAASD,CAAT,EAAYQ,CAAC,GAAG,CAAhB,CAAzB;;AACA,UAAI1C,KAAK,IAAI2C,SAAT,IAAsB3C,KAAK,IAAI4C,aAAnC,EAAkD;AAChDR,QAAAA,SAAS,GAAGO,SAAZ;AACAJ,QAAAA,KAAK,CAACC,KAAN,GAAcE,CAAd;AACAJ,QAAAA,SAAS,GAAGM,aAAZ;AACAL,QAAAA,KAAK,CAACE,KAAN,GAAcC,CAAC,GAAG,CAAlB;AACA;AACD;AACF;AACF,GA1CyB,CA4C1B;;;AACA,MAAIN,SAAS,IAAIC,SAAb,IAA0BC,SAAS,IAAID,SAA3C,EAAsD;AACpD,QAAIQ,OAAO,GAAG;AACZjC,MAAAA,IAAI,EAAE,eADM;AAEZE,MAAAA,IAAI,EAAE;AAFM,KAAd;AAIA,WAAO+B,OAAP;AACD;;AAED,MAAIC,OAAO,GAAGT,SAAd;AACA,MAAIU,CAAC,GAAGV,SAAR,CAtD0B,CAuD1B;;AACA,MAAIhC,IAAI,CAAC2C,GAAL,CAAShD,KAAK,GAAGsC,SAAjB,IAA8BjC,IAAI,CAAC2C,GAAL,CAAShD,KAAK,GAAGoC,SAAjB,CAAlC,EAA+D;AAC7DU,IAAAA,OAAO,GAAGR,SAAV;AACAS,IAAAA,CAAC,GAAGR,KAAK,CAACE,KAAV;AACD,GAHD,MAGO;AACLK,IAAAA,OAAO,GAAGV,SAAV;AACAW,IAAAA,CAAC,GAAGR,KAAK,CAACC,KAAV;AACD;;AAED,MAAIS,MAAM,GAAG,EAAb,CAhE0B,CAiE1B;;AACA,MAAIC,KAAK,GAAG7C,IAAI,CAAC8C,GAAL,CAASnD,KAAT,EAAgB8C,OAAhB,IAA2BzC,IAAI,CAAC+C,GAAL,CAASpD,KAAT,EAAgB8C,OAAhB,CAAvC;;AACA,UAAQI,KAAK,GAAG,KAAhB;AACE,SAAK,IAAL;AACED,MAAAA,MAAM,GAAG,SAAT;AACA;;AACF,SAAK,KAAL;AACE,UAAIjD,KAAK,GAAG8C,OAAZ,EAAqB;AACnBG,QAAAA,MAAM,GAAG,OAAT;AACD,OAFD,MAEO;AACLA,QAAAA,MAAM,GAAG,MAAT;AACD;;AACD;AAVJ,GAnE0B,CAgF1B;;;AACA,MAAIpC,MAAM,GAAG,CAAb;AACA,MAAIwC,KAAK,GAAG,CAAZ;AACA,MAAIzC,IAAI,GAAG,EAAX;AACA,MAAI0C,KAAK,GAAG,CAAC,GAAD,EAAK,OAAL,EAAa,GAAb,EAAiB,OAAjB,EAAyB,GAAzB,EAA6B,GAA7B,EAAiC,OAAjC,EAA0C,GAA1C,EAA+C,OAA/C,EAAwD,GAAxD,EAA6D,OAA7D,EAAsE,GAAtE,CAAZ;;AACA,MAAIP,CAAC,IAAI,CAAT,EAAY;AACV,SAAK,IAAIL,CAAC,GAAG,CAAb,EAAgBA,CAAC,IAAIK,CAArB,EAAwBL,CAAC,EAAzB,EAA6B;AAC3B,UAAIW,KAAK,GAAG,EAAZ,EAAgB;AACdA,QAAAA,KAAK,GAAG,CAAR;AACAxC,QAAAA,MAAM,IAAI,CAAV;AACD;;AACDD,MAAAA,IAAI,GAAG0C,KAAK,CAACD,KAAD,CAAZ;AACAA,MAAAA,KAAK,IAAI,CAAT;AACD;AACF,GATD,MASO;AACL,SAAK,IAAIX,CAAC,GAAG,CAAb,EAAgBA,CAAC,IAAIK,CAArB,EAAwBL,CAAC,EAAzB,EAA6B;AAC3B,UAAIW,KAAK,GAAG,CAAZ,EAAe;AACbA,QAAAA,KAAK,GAAG,EAAR;AACAxC,QAAAA,MAAM,IAAI,CAAV;AACD;;AACDD,MAAAA,IAAI,GAAG0C,KAAK,CAACD,KAAD,CAAZ;AACAA,MAAAA,KAAK,IAAI,CAAT;AACD;AACF;;AAED,MAAIE,MAAM,GAAG;AACX3C,IAAAA,IAAI,EAAG,GAAEA,IAAK,EADH;AAEXC,IAAAA,MAAM,EAAG,GAAEA,MAAO,EAFP;AAGXC,IAAAA,IAAI,EAAEmC;AAHK,GAAb;AAMA,SAAOM,MAAP;AACD,C,CAGD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sourcesContent":["// test.js\nimport { findPitch } from 'pitchy';\n\nfunction updatePitch(analyserNode, sampleRate) {\n  let data = new Float32Array(analyserNode.fftSize);\n  analyserNode.getFloatTimeDomainData(data);\n  let [pitch, clarity] = findPitch(data, sampleRate);\n\n  if (clarity > 0.95) {\n    let converted = pitchToNote(pitch)\n    let roundedPitch = Math.round(pitch * 100) / 100\n    let roundedClarity = Math.round(clarity * 100)\n    document.getElementById('mic').textContent = \"Singing\"\n    document.getElementById('pitch').textContent = String(roundedPitch);\n    document.getElementById('note').textContent = converted.note;\n    document.getElementById('octave').textContent = converted.octave;\n    document.getElementById('tuning').textContent = converted.tune;\n    document.getElementById('clarity').textContent = String(roundedClarity);\n    document.getElementById('clarity').style.color = \"green\"\n  } else {\n    let roundedClarity = Math.round(clarity * 100)\n    document.getElementById('mic').textContent = \"Quiet\"\n    document.getElementById('clarity').textContent = String(roundedClarity);\n    document.getElementById('clarity').style.color = \"red\"\n  }\n  window.requestAnimationFrame(() => updatePitch(analyserNode, sampleRate));\n}\n\ndocument.addEventListener(\"DOMContentLoaded\", () => {\n  // For cross-browser compatibility.\n  let audioContext = new (window.AudioContext || window.webkitAudioContext)();\n  let analyserNode = audioContext.createAnalyser();\n\n  navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {\n    let sourceNode = audioContext.createMediaStreamSource(stream);\n    sourceNode.connect(analyserNode);\n    updatePitch(analyserNode, audioContext.sampleRate);\n  });\n});\n\nfunction pitchToNote(pitch) {\n  // A4 = 440 Hz\n  // Note frequencies are found using the equation\n  // f(n) = 440 * (2^(1/12))^(n)\n  // where n is the number of half steps the note is from A4\n  // n may be positive, indicating higher notes, or negative, for lower notes\n  // 12 half steps in an octave\n\n  let A4 = 440\n  let a = Math.pow(2, (1/12))\n  let stepAbove = undefined\n  let stepBelow = undefined\n  let steps = {\n    above: 0,\n    below: 0\n  }\n\n  // step through scales to find nearest notes\n  if (pitch >= A4) {\n    for (let i = 0; i <= 50; i++) {\n      let frequency = A4 * Math.pow(a, i)\n      let nextFrequency = A4 * Math.pow(a, i + 1)\n      if (pitch >= frequency && pitch <= nextFrequency) {\n        stepAbove = nextFrequency\n        steps.above = i + 1\n        stepBelow = frequency\n        steps.below = i\n        break\n      }\n    }\n  } else {\n    for (let i = 0; i >= -57; i--) {\n      let frequency = A4 * Math.pow(a, i)\n      let nextFrequency = A4 * Math.pow(a, i - 1)\n      if (pitch <= frequency && pitch >= nextFrequency) {\n        stepAbove = frequency\n        steps.above = i\n        stepBelow = nextFrequency\n        steps.below = i - 1\n        break\n      }\n    }\n  }\n\n  // if we didn't find a note, return early\n  if (stepAbove == undefined || stepBelow == undefined) {\n    let outside = {\n      note: \"Outside Range\",\n      tune: \"Outside Range\"\n    }\n    return outside\n  }\n\n  let closest = undefined\n  let n = undefined\n  // figure out which note is closer, and remember how many steps away it is\n  if (Math.abs(pitch - stepBelow) < Math.abs(pitch - stepAbove)) {\n    closest = stepBelow\n    n = steps.below\n  } else {\n    closest = stepAbove\n    n = steps.above\n  }\n\n  let tuning = \"\"\n  // see how out of tune we are\n  let ratio = Math.max(pitch, closest) / Math.min(pitch, closest)\n  switch (ratio < 1.042) {\n    case true:\n      tuning = \"Perfect\"\n      break\n    case false:\n      if (pitch > closest) {\n        tuning = \"Sharp\"\n      } else {\n        tuning = \"Flat\"\n      }\n      break\n  }\n\n  // finally find the note for our pitch\n  let octave = 4\n  let index = 9\n  let note = \"\"\n  let notes = [\"C\",\"C♯/D♭\",\"D\",\"D♯/E♭\",\"E\",\"F\",\"F♯/G♭\", \"G\", \"G♯/A♭\", \"A\", \"A♯/B♭\", \"B\"]\n  if (n >= 0) {\n    for (let i = 0; i <= n; i++) {\n      if (index > 11) {\n        index = 0\n        octave += 1\n      }\n      note = notes[index]\n      index += 1\n    }\n  } else {\n    for (let i = 0; i >= n; i--) {\n      if (index < 0) {\n        index = 11 \n        octave -= 1 \n      }\n      note = notes[index]\n      index -= 1\n    }\n  }\n\n  let output = {\n    note: `${note}`,\n    octave: `${octave}`,\n    tune: tuning\n  }\n\n  return output\n}\n\n\n// C0  16.35\n// C#0/Db0    17.32\n// D0  18.35\n// D#0/Eb0    19.45\n// E0  20.60\n// F0  21.83\n// F#0/Gb0    23.12\n// G0  24.50\n// G#0/Ab0    25.96\n// A0  27.50\n// A#0/Bb0    29.14\n// B0  30.87\n// C1  32.70\n// C#1/Db1    34.65\n// D1  36.71\n// D#1/Eb1    38.89\n// E1  41.20\n// F1  43.65\n// F#1/Gb1    46.25\n// G1  49.00\n// G#1/Ab1    51.91 \n// A1  55.00 \n// A#1/Bb1    58.27 \n// B1  61.74 \n// C2  65.41 \n// C#2/Db2    69.30 \n// D2  73.42 \n// D#2/Eb2    77.78 \n// E2  82.41 \n// F2  87.31 \n// F#2/Gb2    92.50 \n// G2  98.00 \n// G#2/Ab2    103.83\n// A2  110.00\n// A#2/Bb2    116.54\n// B2  123.47\n// C3  130.81\n// C#3/Db3    138.59\n// D3  146.83\n// D#3/Eb3    155.56\n// E3  164.81\n// F3  174.61\n// F#3/Gb3    185.00\n// G3  196.00\n// G#3/Ab3    207.65\n// A3  220.00\n// A#3/Bb3    233.08\n// B3  246.94\n// C4  261.63\n// C#4/Db4    277.18\n// D4  293.66\n// D#4/Eb4    311.13\n// E4  329.63\n// F4  349.23\n// F#4/Gb4    369.99\n// G4  392.00\n// G#4/Ab4    415.30\n// A4  440.00\n// A#4/Bb4    466.16\n// B4  493.88\n// C5  523.25\n// C#5/Db5    554.37\n// D5  587.33\n// D#5/Eb5    622.25\n// E5  659.25\n// F5  698.46\n// F#5/Gb5    739.99\n// G5  783.99\n// G#5/Ab5    830.61\n// A5  880.00\n// A#5/Bb5    932.33\n// B5  987.77\n// C6  1046.50 \n// C#6/Db6    1108.73 \n// D6  1174.66 \n// D#6/Eb6    1244.51 \n// E6  1318.51 \n// F6  1396.91 \n// F#6/Gb6    1479.98 \n// G6  1567.98 \n// G#6/Ab6    1661.22 \n// A6  1760.00 \n// A#6/Bb6    1864.66 \n// B6  1975.53\n// C7  2093.00\n// C#7/Db7    2217.46\n// D7  2349.32\n// D#7/Eb7    2489.02\n// E7  2637.02\n// F7  2793.83\n// F#7/Gb7    2959.96\n// G7  3135.96\n// G#7/Ab7    3322.44\n// A7  3520.00\n// A#7/Bb7    3729.31\n// B7  3951.07\n// C8  4186.01\n// C#8/Db8    4434.92\n// D8  4698.63\n// D#8/Eb8    4978.03\n// E8  5274.04\n// F8  5587.65\n// F#8/Gb8    5919.91\n// G8  6271.93\n// G#8/Ab8    6644.88\n// A8  7040.00\n// A#8/Bb8    7458.62\n// B8  7902.13"],"file":"listener.js"}